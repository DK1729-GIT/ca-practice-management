<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA Practice Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1e3c72;
            --primary-light: #2a5298;
            --secondary: #e1e8ed;
            --danger: #dc3545;
            --success: #0f5132;
            --warning: #856404;
            --bg: #f5f7fa;
            --text: #2c3e50;
            --text-light: #657786;
            --border: #e1e8ed;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }

        /* LOGIN PAGE */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 1rem;
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-header { text-align: center; margin-bottom: 2rem; }
        .login-header h1 { color: var(--primary); font-size: 1.8rem; margin-bottom: 0.5rem; }
        .login-header p { color: var(--text-light); font-size: 0.9rem; }

        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        .form-group input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
        }
        .form-group input:focus { outline: none; border-color: var(--primary); }

        .btn {
            width: 100%;
            padding: 0.9rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

        .toggle-form {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        .toggle-form a { color: var(--primary); cursor: pointer; text-decoration: none; font-weight: 600; }
        .toggle-form a:hover { text-decoration: underline; }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }
        .alert-success { background: #d1e7dd; color: var(--success); border-left: 4px solid var(--success); }
        .alert-error { background: #f8d7da; color: var(--danger); border-left: 4px solid var(--danger); }

        /* MAIN APP */
        #mainApp { display: none; }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 { font-size: 1.5rem; }
        .header p { opacity: 0.9; font-size: 0.85rem; margin-top: 0.3rem; }

        .user-info { text-align: right; }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 1rem;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .tab {
            padding: 0.8rem 1.2rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        .tab:hover { color: var(--primary); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .stat-label { color: var(--text-light); margin-top: 0.5rem; }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        .card h3 { color: var(--primary); margin-bottom: 1rem; }

        .btn-secondary { background: var(--secondary); color: var(--text); margin: 0.5rem; }
        .btn-danger { background: var(--danger); color: white; }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            overflow-y: auto;
        }
        .modal.active { display: flex; }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .login-card { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div id="authPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>CA Practice Management</h1>
                <p id="authSubtitle">Sign in to your account</p>
            </div>

            <div id="alertBox" class="alert"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn">Login</button>
            </form>

            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="regFullName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="regUsername" required>
                </div>
                <div class="form-group">
                    <label>Password (min 6 characters)</label>
                    <input type="password" id="regPassword" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" id="registerBtn">Create Account</button>
            </form>

            <div class="toggle-form">
                <span id="toggleText">Don't have an account?</span>
                <a id="toggleLink">Sign up</a>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <div class="header">
            <div>
                <h1>CA Practice Management System</h1>
                <p>Streamline your practice with intelligent management</p>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="user-info">
                    <div id="userName" style="font-weight: 600;"></div>
                    <div id="userEmail" style="font-size: 0.8rem; opacity: 0.8;"></div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="tab" onclick="switchTab('clients')">üë• Clients</button>
                <button class="tab" onclick="switchTab('tasks')">‚úì Tasks</button>
                <button class="tab" onclick="switchTab('calendar')">üìÖ Calendar</button>
                <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalClients">0</div>
                        <div class="stat-label">Total Clients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingTasks">0</div>
                        <div class="stat-label">Pending Tasks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completedMonth">0</div>
                        <div class="stat-label">Completed This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="upcomingDeadlines">0</div>
                        <div class="stat-label">Upcoming (7 days)</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìå Quick Actions</h3>
                    <button class="btn btn-primary" onclick="openClientModal()">+ New Client</button>
                    <button class="btn btn-secondary" onclick="openTaskModal()">+ New Task</button>
                    <button class="btn btn-secondary" onclick="switchTab('calendar')">View Calendar</button>
                </div>
            </div>

            <!-- Clients Tab -->
            <div id="clients" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <h3>üë• All Clients</h3>
                        <button class="btn btn-primary" onclick="openClientModal()" style="width: auto;">+ New Client</button>
                    </div>
                    <div id="clientsList"></div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div id="tasks" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <h3>‚úì All Tasks</h3>
                        <button class="btn btn-primary" onclick="openTaskModal()" style="width: auto;">+ New Task</button>
                    </div>
                    <div id="tasksList"></div>
                </div>
            </div>

            <!-- Calendar Tab -->
            <div id="calendar" class="tab-content">
                <div class="card">
                    <h3>üìÖ Task Calendar</h3>
                    <p style="color: var(--text-light);">Tasks sorted by deadline with urgency indicators.</p>
                    <div id="calendarTasks"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <h3>üìä Google Sheets Sync</h3>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Import all 42 clients from your Google Sheet in one click!</p>
                    
                    <form id="sheetsSettingsForm" onsubmit="syncGoogleSheets(event)">
                        <div class="form-group">
                            <label>Google Spreadsheet ID *</label>
                            <input type="text" id="spreadsheetId" placeholder="Paste your spreadsheet ID here" required value="1rbLpZ0_0xQctkL4t5AFathnK5Br8ZQK0lKsAqM_yVw0">
                            <small style="color: var(--text-light);">
                                Find this in your sheet URL: docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>Sheet Name (tab name at bottom) *</label>
                            <input type="text" id="sheetName" placeholder="e.g., Sheet1, Clients, Master" required value="Sheet1">
                            <small style="color: var(--text-light);">
                                The name of the sheet tab where your client data is located
                            </small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="syncSheetsBtn">
                            üîÑ Sync Google Sheets (Import 42 Clients)
                        </button>
                    </form>
                    
                    <div id="sheetsStatus" style="margin-top: 1rem;"></div>
                </div>

                <div class="card">
                    <h3>üìã How Google Sheets Sync Works</h3>
                    <ul style="line-height: 2; color: var(--text-light);">
                        <li>‚úÖ <strong>Your Sheet Format:</strong> 10 columns (Client Code, Name, Type, PAN, etc.)</li>
                        <li>‚úÖ <strong>42 Clients:</strong> All will be imported automatically</li>
                        <li>‚úÖ <strong>New Clients:</strong> Added to database</li>
                        <li>‚úÖ <strong>Existing Clients:</strong> Updated with latest data</li>
                        <li>üîÑ <strong>One-Click:</strong> Click sync anytime to refresh data</li>
                        <li>üîí <strong>Secure:</strong> Read-only access to your sheet</li>
                    </ul>
                </div>

                <div class="card">
                    <h3>üìÅ OneDrive Document Scanner</h3>
                    <p style="color: var(--text-light);">Automatically scan and index documents from your "2 My Clients" folder</p>
                    <button class="btn btn-secondary" onclick="alert('OneDrive scanner coming next! Complete Google Sheets first.')">
                        Configure OneDrive Scanner
                    </button>
                </div>

                <div class="card">
                    <h3>üîÑ Coming Soon</h3>
                    <ul style="line-height: 2; color: var(--text-light);">
                        <li>üìß Email Notifications - Deadline reminders</li>
                        <li>üìÖ Daily Summary Emails - 8 AM daily report</li>
                        <li>üîÅ Recurring Tasks - Auto-generate monthly tasks</li>
                        <li>üìä Reports & Analytics</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Client</h2>
                <button class="close-btn" onclick="closeClientModal()">√ó</button>
            </div>
            <form id="clientForm" onsubmit="saveClient(event)">
                <div class="form-group">
                    <label>Client Code *</label>
                    <input type="text" id="clientCode" required placeholder="e.g., 001AA">
                </div>
                <div class="form-group">
                    <label>Client Name *</label>
                    <input type="text" id="clientName" required>
                </div>
                <div class="form-group">
                    <label>Client Type</label>
                    <select id="clientType">
                        <option value="">Select Type</option>
                        <option value="Proprietorship">Proprietorship</option>
                        <option value="Partnership">Partnership</option>
                        <option value="LLP">LLP</option>
                        <option value="Private Limited">Private Limited</option>
                        <option value="Trust">Trust</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>PAN</label>
                    <input type="text" id="clientPAN">
                </div>
                <div class="form-group">
                    <label>GSTIN</label>
                    <input type="text" id="clientGSTIN">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="clientEmail">
                </div>
                <div class="form-group">
                    <label>Mobile</label>
                    <input type="tel" id="clientMobile">
                </div>
                <button type="submit" class="btn btn-primary">Save Client</button>
            </form>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Task</h2>
                <button class="close-btn" onclick="closeTaskModal()">√ó</button>
            </div>
            <form id="taskForm" onsubmit="saveTask(event)">
                <div class="form-group">
                    <label>Client *</label>
                    <input type="text" id="taskClientSearch" placeholder="Type to search client..." autocomplete="off" onkeyup="filterClients()" onfocus="showClientDropdown()" required>
                    <input type="hidden" id="taskClient" required>
                    <div id="clientDropdown" style="display: none; position: relative; max-height: 200px; overflow-y: auto; border: 2px solid var(--border); border-radius: 6px; background: white; margin-top: 0.5rem;">
                        <!-- Client options will be inserted here -->
                    </div>
                    <small style="color: var(--text-light);">Start typing client code or name to search</small>
                </div>
                <div class="form-group">
                    <label>Task Title *</label>
                    <input type="text" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label>Service Type *</label>
                    <select id="taskService" required onchange="toggleOtherService()">
                        <option value="">Select Service</option>
                        <option value="ITR">Income Tax Return</option>
                        <option value="GST">GST Filing</option>
                        <option value="Audit">Audit</option>
                        <option value="ROC">ROC Filing</option>
                        <option value="TDS">TDS Compliance</option>
                        <option value="ESI/PF">ESI/PF Returns</option>
                        <option value="Others">Others (Specify)</option>
                    </select>
                </div>
                <div class="form-group" id="otherServiceField" style="display: none;">
                    <label>Specify Service Type *</label>
                    <input type="text" id="taskServiceOther" placeholder="e.g., Transfer Pricing, FEMA, Tax Planning">
                </div>
                <div class="form-group">
                    <label>Status *</label>
                    <select id="taskStatus" required>
                        <option value="Pending Details from Client">Pending Client</option>
                        <option value="Work in Progress">In Progress</option>
                        <option value="Under Review">Under Review</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Deadline</label>
                    <input type="date" id="taskDeadline">
                </div>
                
                <!-- Recurring Task Section -->
                <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="taskRecurring" onchange="toggleRecurringFields()" style="width: auto;">
                    <label for="taskRecurring" style="margin: 0;">üîÅ Make this a recurring task</label>
                </div>
                
                <div id="recurringFields" style="display: none; background: #f8fbff; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label>Recurrence Pattern *</label>
                        <select id="taskRecurrencePattern" onchange="updateRecurrencePreview()">
                            <option value="">Select Pattern</option>
                            <option value="monthly">Monthly (Every month on same date)</option>
                            <option value="quarterly">Quarterly (Every 3 months)</option>
                            <option value="yearly">Yearly (Every year on same date)</option>
                            <option value="custom_monthly">Custom Monthly (Specific day each month)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="customDayField" style="display: none;">
                        <label>Day of Month (1-31)</label>
                        <input type="number" id="taskDueDay" min="1" max="31" placeholder="e.g., 20 for 20th of each month">
                        <small style="color: var(--text-light);">For GST: Enter 20, for TDS: Enter 7, etc.</small>
                    </div>
                    
                    <div id="recurrencePreview" style="padding: 0.8rem; background: white; border-left: 4px solid var(--primary); margin-top: 1rem; border-radius: 4px; display: none;">
                        <strong>Preview:</strong>
                        <div id="recurrencePreviewText" style="margin-top: 0.5rem; color: var(--text-light);"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="taskNotes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Save Task</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://dk1729git.pythonanywhere.com';
        let currentUser = null;
        let authToken = null;
        let clients = [];
        let tasks = [];

        // Check if logged in
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('auth_token');
            const savedUser = localStorage.getItem('user_info');

            if (savedToken && savedUser) {
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        });

        // Toggle login/register
        let isLoginMode = true;
        document.getElementById('toggleLink').addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            document.getElementById('loginForm').style.display = isLoginMode ? 'block' : 'none';
            document.getElementById('registerForm').style.display = isLoginMode ? 'none' : 'block';
            document.getElementById('toggleText').textContent = isLoginMode ? "Don't have an account?" : "Already have an account?";
            document.getElementById('toggleLink').textContent = isLoginMode ? 'Sign up' : 'Sign in';
            document.getElementById('authSubtitle').textContent = isLoginMode ? 'Sign in to your account' : 'Create a new account';
            hideAlert();
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');

            btn.disabled = true;
            btn.textContent = 'Logging in...';
            hideAlert();

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('auth_token', authToken);
                    localStorage.setItem('user_info', JSON.stringify(currentUser));
                    showAlert('Login successful!', 'success');
                    setTimeout(showMainApp, 1000);
                } else {
                    showAlert(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showAlert('Connection error. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Login';
            }
        });

        // Register
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = document.getElementById('regFullName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const btn = document.getElementById('registerBtn');

            btn.disabled = true;
            btn.textContent = 'Creating account...';
            hideAlert();

            try {
                const response = await fetch(`${API_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, email, password, full_name: fullName })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Account created! Please login.', 'success');
                    document.getElementById('loginUsername').value = username;
                    document.getElementById('loginPassword').value = password;
                    setTimeout(() => document.getElementById('toggleLink').click(), 1500);
                } else {
                    showAlert(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showAlert('Connection error. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        });

        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
        }

        function hideAlert() {
            document.getElementById('alertBox').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.full_name || currentUser.username;
            document.getElementById('userEmail').textContent = currentUser.email;
            loadDashboard();
        }

        async function loadDashboard() {
            try {
                // Load stats
                const statsRes = await fetch(`${API_URL}/api/stats/dashboard?token=${authToken}`);
                const statsData = await statsRes.json();
                if (statsData.success) {
                    document.getElementById('totalClients').textContent = statsData.stats.total_clients;
                    document.getElementById('pendingTasks').textContent = statsData.stats.pending_tasks;
                    document.getElementById('completedMonth').textContent = statsData.stats.completed_this_month;
                    document.getElementById('upcomingDeadlines').textContent = statsData.stats.upcoming_deadlines;
                }

                // Load clients
                const clientsRes = await fetch(`${API_URL}/api/clients?token=${authToken}`);
                const clientsData = await clientsRes.json();
                if (clientsData.success) {
                    clients = clientsData.clients;
                    renderClients();
                }

                // Load tasks
                const tasksRes = await fetch(`${API_URL}/api/tasks?token=${authToken}`);
                const tasksData = await tasksRes.json();
                if (tasksData.success) {
                    tasks = tasksData.tasks;
                    renderTasks();
                    renderCalendar();
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function renderClients() {
            const container = document.getElementById('clientsList');
            if (clients.length === 0) {
                container.innerHTML = '<div class="empty-state">No clients yet. Click "New Client" to add one!</div>';
                return;
            }

            container.innerHTML = clients.map(client => `
                <div style="padding: 1rem; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div style="font-weight: 600; color: var(--primary);">${client.client_code}</div>
                            <div style="font-size: 1.1rem; margin: 0.5rem 0;">${client.client_name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">
                                ${client.client_type || 'N/A'} ${client.pan ? '‚Ä¢ PAN: ' + client.pan : ''}
                                ${client.email ? '‚Ä¢ ' + client.email : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editClient('${client.client_code}')" style="width: auto; padding: 0.5rem 1rem;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteClient('${client.client_code}')" style="width: auto; padding: 0.5rem 1rem;">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state">No tasks yet. Click "New Task" to add one!</div>';
                return;
            }

            container.innerHTML = tasks.map(task => {
                const client = clients.find(c => c.client_code === task.client_code);
                const isRecurring = task.is_recurring || false;
                const recurringBadge = isRecurring ? '<span style="padding: 0.3rem 0.8rem; background: #fff3cd; color: #856404; border-radius: 20px; font-size: 0.75rem; margin-left: 0.5rem;">üîÅ Recurring</span>' : '';
                
                return `
                    <div style="padding: 1rem; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600;">
                                    ${task.title}
                                    ${recurringBadge}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-light); margin: 0.5rem 0;">
                                    Client: ${client ? client.client_name : task.client_code} ‚Ä¢ 
                                    Service: ${task.service} ‚Ä¢ 
                                    ${task.deadline ? 'Due: ' + new Date(task.deadline).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) : 'No deadline'}
                                </div>
                                <span style="padding: 0.3rem 0.8rem; background: #e7f3f8; color: #17a2b8; border-radius: 20px; font-size: 0.8rem;">
                                    ${task.status}
                                </span>
                                ${isRecurring ? `<span style="padding: 0.3rem 0.8rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 20px; font-size: 0.75rem; margin-left: 0.5rem;">${getRecurrenceLabel(task)}</span>` : ''}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="editTask('${task.task_id}')" style="width: auto; padding: 0.5rem 1rem;">Edit</button>
                                <button class="btn btn-danger" onclick="deleteTask('${task.task_id}')" style="width: auto; padding: 0.5rem 1rem;">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getRecurrenceLabel(task) {
            if (!task.recurrence_pattern) return '';
            
            const labels = {
                'monthly': 'Monthly',
                'quarterly': 'Quarterly',
                'yearly': 'Yearly',
                'custom_monthly': `Monthly (${task.due_day}${getDaySuffix(task.due_day)})`
            };
            
            return labels[task.recurrence_pattern] || task.recurrence_pattern;
        }

        function renderCalendar() {
            const container = document.getElementById('calendarTasks');
            
            // Get all tasks with deadlines, sorted by deadline
            const tasksWithDeadlines = tasks
                .filter(t => t.deadline)
                .sort((a, b) => new Date(a.deadline) - new Date(b.deadline));

            if (tasksWithDeadlines.length === 0) {
                container.innerHTML = '<div class="empty-state">No tasks with deadlines yet</div>';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            container.innerHTML = tasksWithDeadlines.map(task => {
                const client = clients.find(c => c.client_code === task.client_code);
                const deadline = new Date(task.deadline);
                const daysUntil = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                
                let borderColor = 'var(--primary)';
                let bgColor = '#f8fbff';
                let urgencyText = '';
                
                if (daysUntil < 0) {
                    borderColor = 'var(--danger)';
                    bgColor = '#fff5f5';
                    urgencyText = `<span style="color: var(--danger); font-weight: 600;">Overdue by ${Math.abs(daysUntil)} day${Math.abs(daysUntil) > 1 ? 's' : ''}</span>`;
                } else if (daysUntil === 0) {
                    borderColor = 'var(--warning)';
                    bgColor = '#fff8e1';
                    urgencyText = '<span style="color: var(--warning); font-weight: 600;">Due Today!</span>';
                } else if (daysUntil <= 3) {
                    borderColor = 'var(--warning)';
                    bgColor = '#fff8e1';
                    urgencyText = `<span style="color: var(--warning); font-weight: 600;">Due in ${daysUntil} day${daysUntil > 1 ? 's' : ''}</span>`;
                } else {
                    urgencyText = `Due in ${daysUntil} days`;
                }

                return `
                    <div style="padding: 1rem; border-left: 4px solid ${borderColor}; background: ${bgColor}; border-radius: 6px; margin-bottom: 1rem;">
                        <div style="font-weight: 600;">${task.title}</div>
                        <div style="font-size: 0.85rem; color: var(--text-light); margin: 0.5rem 0;">
                            ${client ? client.client_name : task.client_code} ‚Ä¢ 
                            ${deadline.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })} ‚Ä¢ 
                            ${urgencyText}
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span style="padding: 0.3rem 0.8rem; background: white; border: 1px solid var(--border); border-radius: 20px; font-size: 0.75rem;">
                                ${task.status}
                            </span>
                            <span style="padding: 0.3rem 0.8rem; background: white; border: 1px solid var(--border); border-radius: 20px; font-size: 0.75rem; margin-left: 0.5rem;">
                                ${task.service}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function openClientModal() {
            currentEditingClient = null;
            document.getElementById('clientModal').querySelector('h2').textContent = 'New Client';
            document.getElementById('clientForm').reset();
            document.getElementById('clientCode').disabled = false;
            document.getElementById('clientModal').classList.add('active');
        }

        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('active');
            document.getElementById('clientForm').reset();
            currentEditingClient = null;
        }

        let currentEditingClient = null;

        function editClient(clientCode) {
            const client = clients.find(c => c.client_code === clientCode);
            if (!client) return;

            currentEditingClient = client;
            
            // Fill form with client data
            document.getElementById('clientCode').value = client.client_code;
            document.getElementById('clientName').value = client.client_name;
            document.getElementById('clientType').value = client.client_type || '';
            document.getElementById('clientPAN').value = client.pan || '';
            document.getElementById('clientGSTIN').value = client.gstin || '';
            document.getElementById('clientEmail').value = client.email || '';
            document.getElementById('clientMobile').value = client.mobile_number || '';
            
            // Change modal title and disable client code editing
            document.getElementById('clientModal').querySelector('h2').textContent = 'Edit Client';
            document.getElementById('clientCode').disabled = true;
            
            document.getElementById('clientModal').classList.add('active');
        }

        async function saveClient(e) {
            e.preventDefault();
            const clientData = {
                client_code: document.getElementById('clientCode').value.trim(),
                client_name: document.getElementById('clientName').value.trim(),
                client_type: document.getElementById('clientType').value,
                pan: document.getElementById('clientPAN').value.trim(),
                gstin: document.getElementById('clientGSTIN').value.trim(),
                email: document.getElementById('clientEmail').value.trim(),
                mobile_number: document.getElementById('clientMobile').value.trim()
            };

            try {
                let response, method, url;
                
                if (currentEditingClient) {
                    // Update existing client
                    method = 'PUT';
                    url = `${API_URL}/api/clients/${clientData.client_code}`;
                } else {
                    // Create new client
                    method = 'POST';
                    url = `${API_URL}/api/clients`;
                }

                response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(clientData)
                });

                const data = await response.json();

                if (data.success) {
                    alert(currentEditingClient ? 'Client updated successfully!' : 'Client added successfully!');
                    closeClientModal();
                    loadDashboard();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Connection error. Please try again.');
            }
        }

        async function deleteClient(clientCode) {
            if (!confirm('Delete this client?')) return;

            try {
                const response = await fetch(`${API_URL}/api/clients/${clientCode}?token=${authToken}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Client deleted!');
                    loadDashboard();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Connection error.');
            }
        }

        function openTaskModal() {
            currentEditingTask = null;
            document.getElementById('taskModal').querySelector('h2').textContent = 'New Task';
            document.getElementById('taskForm').reset();
            document.getElementById('recurringFields').style.display = 'none';
            document.getElementById('taskRecurring').checked = false;
            document.getElementById('otherServiceField').style.display = 'none';
            document.getElementById('clientDropdown').style.display = 'none';
            document.getElementById('taskClient').value = '';
            document.getElementById('taskClientSearch').value = '';
            
            // Populate client dropdown initially
            populateClientDropdown();
            
            document.getElementById('taskModal').classList.add('active');
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            document.getElementById('taskForm').reset();
            document.getElementById('clientDropdown').style.display = 'none';
            currentEditingTask = null;
        }

        function populateClientDropdown(filterText = '') {
            const dropdown = document.getElementById('clientDropdown');
            
            let filteredClients = clients;
            if (filterText) {
                const search = filterText.toLowerCase();
                filteredClients = clients.filter(c => 
                    c.client_code.toLowerCase().includes(search) || 
                    c.client_name.toLowerCase().includes(search)
                );
            }
            
            if (filteredClients.length === 0) {
                dropdown.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-light);">No clients found</div>';
                return;
            }
            
            dropdown.innerHTML = filteredClients.map(c => `
                <div onclick="selectClient('${c.client_code}', '${c.client_name.replace(/'/g, "\\'")}')" 
                     style="padding: 0.8rem; cursor: pointer; border-bottom: 1px solid var(--border);"
                     onmouseover="this.style.background='#f5f7fa'" 
                     onmouseout="this.style.background='white'">
                    <div style="font-weight: 600; color: var(--primary);">${c.client_code}</div>
                    <div style="font-size: 0.85rem; color: var(--text-light);">${c.client_name}</div>
                </div>
            `).join('');
        }

        function showClientDropdown() {
            document.getElementById('clientDropdown').style.display = 'block';
            populateClientDropdown();
        }

        function filterClients() {
            const searchText = document.getElementById('taskClientSearch').value;
            populateClientDropdown(searchText);
            document.getElementById('clientDropdown').style.display = 'block';
        }

        function selectClient(clientCode, clientName) {
            document.getElementById('taskClient').value = clientCode;
            document.getElementById('taskClientSearch').value = `${clientCode} - ${clientName}`;
            document.getElementById('clientDropdown').style.display = 'none';
        }

        function toggleOtherService() {
            const serviceValue = document.getElementById('taskService').value;
            const otherField = document.getElementById('otherServiceField');
            
            if (serviceValue === 'Others') {
                otherField.style.display = 'block';
                document.getElementById('taskServiceOther').required = true;
            } else {
                otherField.style.display = 'none';
                document.getElementById('taskServiceOther').required = false;
                document.getElementById('taskServiceOther').value = '';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('clientDropdown');
            const searchInput = document.getElementById('taskClientSearch');
            
            if (dropdown && searchInput && 
                !dropdown.contains(event.target) && 
                event.target !== searchInput) {
                dropdown.style.display = 'none';
            }
        });

        let currentEditingTask = null;

        function toggleRecurringFields() {
            const isRecurring = document.getElementById('taskRecurring').checked;
            document.getElementById('recurringFields').style.display = isRecurring ? 'block' : 'none';
            
            if (!isRecurring) {
                document.getElementById('taskRecurrencePattern').value = '';
                document.getElementById('recurrencePreview').style.display = 'none';
            }
        }

        function updateRecurrencePreview() {
            const pattern = document.getElementById('taskRecurrencePattern').value;
            const deadline = document.getElementById('taskDeadline').value;
            const customDayField = document.getElementById('customDayField');
            const preview = document.getElementById('recurrencePreview');
            const previewText = document.getElementById('recurrencePreviewText');
            
            // Show/hide custom day field
            customDayField.style.display = pattern === 'custom_monthly' ? 'block' : 'none';
            
            if (!pattern) {
                preview.style.display = 'none';
                return;
            }
            
            let text = '';
            const today = new Date();
            const baseDate = deadline ? new Date(deadline) : today;
            
            if (pattern === 'monthly') {
                const day = baseDate.getDate();
                text = `This task will repeat on the <strong>${day}${getDaySuffix(day)}</strong> of every month.<br>`;
                text += `Next occurrences: ${getNextOccurrences(baseDate, 'monthly', 3)}`;
            } else if (pattern === 'quarterly') {
                const day = baseDate.getDate();
                const month = baseDate.getMonth();
                text = `This task will repeat every 3 months on the same date.<br>`;
                text += `Next occurrences: ${getNextOccurrences(baseDate, 'quarterly', 3)}`;
            } else if (pattern === 'yearly') {
                const day = baseDate.getDate();
                const month = baseDate.toLocaleString('default', { month: 'long' });
                text = `This task will repeat every year on <strong>${day}${getDaySuffix(day)} ${month}</strong>.<br>`;
                text += `Next occurrences: ${getNextOccurrences(baseDate, 'yearly', 3)}`;
            } else if (pattern === 'custom_monthly') {
                const dueDay = document.getElementById('taskDueDay').value;
                if (dueDay) {
                    text = `This task will repeat on the <strong>${dueDay}${getDaySuffix(parseInt(dueDay))}</strong> of every month.<br>`;
                    const customDate = new Date(today.getFullYear(), today.getMonth(), parseInt(dueDay));
                    text += `Next occurrences: ${getNextOccurrences(customDate, 'monthly', 3)}`;
                } else {
                    text = 'Enter the day of month above to see preview.';
                }
            }
            
            previewText.innerHTML = text;
            preview.style.display = 'block';
        }

        function getDaySuffix(day) {
            if (day >= 11 && day <= 13) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        function getNextOccurrences(baseDate, pattern, count) {
            const dates = [];
            let currentDate = new Date(baseDate);
            
            for (let i = 0; i < count; i++) {
                if (pattern === 'monthly') {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                } else if (pattern === 'quarterly') {
                    currentDate.setMonth(currentDate.getMonth() + 3);
                } else if (pattern === 'yearly') {
                    currentDate.setFullYear(currentDate.getFullYear() + 1);
                }
                dates.push(currentDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }));
                currentDate = new Date(currentDate);
            }
            
            return dates.join(', ');
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.task_id === taskId);
            if (!task) return;

            currentEditingTask = task;
            
            // Populate client search field
            const client = clients.find(c => c.client_code === task.client_code);
            if (client) {
                document.getElementById('taskClient').value = task.client_code;
                document.getElementById('taskClientSearch').value = `${client.client_code} - ${client.client_name}`;
            }
            
            // Fill form with task data
            document.getElementById('taskTitle').value = task.title;
            
            // Handle service type (check if it's a custom "Others" value)
            const serviceSelect = document.getElementById('taskService');
            const serviceOptions = Array.from(serviceSelect.options).map(opt => opt.value);
            
            if (serviceOptions.includes(task.service)) {
                serviceSelect.value = task.service;
                document.getElementById('otherServiceField').style.display = 'none';
            } else {
                serviceSelect.value = 'Others';
                document.getElementById('otherServiceField').style.display = 'block';
                document.getElementById('taskServiceOther').value = task.service;
            }
            
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskDeadline').value = task.deadline || '';
            document.getElementById('taskNotes').value = task.notes || '';
            
            // Handle recurring fields
            const isRecurring = task.is_recurring || false;
            document.getElementById('taskRecurring').checked = isRecurring;
            
            if (isRecurring) {
                document.getElementById('recurringFields').style.display = 'block';
                document.getElementById('taskRecurrencePattern').value = task.recurrence_pattern || '';
                if (task.due_day) {
                    document.getElementById('taskDueDay').value = task.due_day;
                }
                updateRecurrencePreview();
            } else {
                document.getElementById('recurringFields').style.display = 'none';
            }
            
            // Change modal title
            document.getElementById('taskModal').querySelector('h2').textContent = 'Edit Task';
            
            document.getElementById('taskModal').classList.add('active');
        }

        async function saveTask(e) {
            e.preventDefault();
            
            const isRecurring = document.getElementById('taskRecurring').checked;
            const recurrencePattern = document.getElementById('taskRecurrencePattern').value;
            const dueDay = document.getElementById('taskDueDay').value;
            
            // Validation for recurring tasks
            if (isRecurring && !recurrencePattern) {
                alert('Please select a recurrence pattern for recurring tasks');
                return;
            }
            
            if (recurrencePattern === 'custom_monthly' && !dueDay) {
                alert('Please enter the day of month for custom monthly recurrence');
                return;
            }
            
            // Get service type (handle Others)
            let serviceType = document.getElementById('taskService').value;
            if (serviceType === 'Others') {
                const otherService = document.getElementById('taskServiceOther').value.trim();
                if (!otherService) {
                    alert('Please specify the service type');
                    return;
                }
                serviceType = otherService;
            }
            
            const taskData = {
                task_id: currentEditingTask ? currentEditingTask.task_id : Date.now().toString(),
                client_code: document.getElementById('taskClient').value,
                title: document.getElementById('taskTitle').value.trim(),
                service: serviceType,
                status: document.getElementById('taskStatus').value,
                deadline: document.getElementById('taskDeadline').value || null,
                notes: document.getElementById('taskNotes').value.trim(),
                is_recurring: isRecurring,
                recurrence_pattern: isRecurring ? recurrencePattern : null,
                due_day: (isRecurring && dueDay) ? parseInt(dueDay) : null
            };

            try {
                let response, method, url;
                
                if (currentEditingTask) {
                    // Update existing task - use PUT method
                    method = 'PUT';
                    url = `${API_URL}/api/tasks/${taskData.task_id}`;
                    
                    // For updates, we need to send the data differently
                    response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            title: taskData.title,
                            service: taskData.service,
                            status: taskData.status,
                            deadline: taskData.deadline,
                            notes: taskData.notes,
                            is_recurring: taskData.is_recurring,
                            recurrence_pattern: taskData.recurrence_pattern,
                            due_day: taskData.due_day,
                            time_log: JSON.stringify([
                                ...(currentEditingTask.time_log ? JSON.parse(currentEditingTask.time_log) : []),
                                {
                                    timestamp: new Date().toISOString(),
                                    action: 'Updated',
                                    status: taskData.status
                                }
                            ])
                        })
                    });
                } else {
                    // Create new task
                    method = 'POST';
                    url = `${API_URL}/api/tasks`;
                    taskData.time_log = JSON.stringify([{
                        timestamp: new Date().toISOString(),
                        action: 'Created',
                        status: taskData.status
                    }]);
                    
                    response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(taskData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    const recurringMsg = taskData.is_recurring ? ' (Recurring task configured!)' : '';
                    alert((currentEditingTask ? 'Task updated' : 'Task added') + ' successfully!' + recurringMsg);
                    closeTaskModal();
                    loadDashboard();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Connection error. Please try again.');
                console.error('Error saving task:', error);
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;

            try {
                const response = await fetch(`${API_URL}/api/tasks/${taskId}?token=${authToken}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Task deleted!');
                    loadDashboard();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Connection error.');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_info');
                location.reload();
            }
        }

        // Google Sheets Sync Function
        async function syncGoogleSheets(e) {
            e.preventDefault();
            
            const btn = document.getElementById('syncSheetsBtn');
            const statusDiv = document.getElementById('sheetsStatus');
            
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            const sheetName = document.getElementById('sheetName').value.trim();
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Syncing... Please wait';
            statusDiv.innerHTML = '<div style="padding: 1rem; background: #e7f3f8; border-radius: 6px;">üìä Reading Google Sheets and importing clients...</div>';
            
            try {
                const response = await fetch(`${API_URL}/api/sync/google-sheets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        spreadsheet_id: spreadsheetId,
                        sheet_name: sheetName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const result = data.details;
                    statusDiv.innerHTML = `
                        <div style="padding: 1rem; background: #d1e7dd; color: #0f5132; border-radius: 6px;">
                            ‚úÖ <strong>Sync Complete!</strong><br><br>
                            üìä Total Clients in Sheet: ${result.total}<br>
                            ‚ûï New Clients Added: ${result.new}<br>
                            üîÑ Existing Clients Updated: ${result.updated}<br>
                            ${result.errors > 0 ? `‚ö†Ô∏è Errors: ${result.errors}<br>` : ''}
                            <br>
                            <strong>All ${result.total} clients are now in your system!</strong><br>
                            Go to the Clients tab to see them.
                        </div>
                    `;
                    
                    // Save settings for future syncs
                    localStorage.setItem('spreadsheet_id', spreadsheetId);
                    localStorage.setItem('sheet_name', sheetName);
                    
                    // Reload dashboard to show new stats
                    setTimeout(() => {
                        loadDashboard();
                        alert(`‚úÖ Successfully imported ${result.total} clients! Check the Clients tab.`);
                    }, 2000);
                } else {
                    statusDiv.innerHTML = `
                        <div style="padding: 1rem; background: #f8d7da; color: #842029; border-radius: 6px;">
                            ‚ùå <strong>Sync Failed</strong><br><br>
                            ${data.error}<br><br>
                            <strong>Common issues:</strong><br>
                            ‚Ä¢ Make sure the Spreadsheet ID is correct<br>
                            ‚Ä¢ Check that service_account.json is uploaded to PythonAnywhere<br>
                            ‚Ä¢ Verify the sheet name matches your tab name (e.g., Sheet1)<br>
                            ‚Ä¢ Ensure the sheet is shared with service account email
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div style="padding: 1rem; background: #f8d7da; color: #842029; border-radius: 6px;">
                        ‚ùå <strong>Connection Error</strong><br><br>
                        Could not connect to backend. Error: ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Sync Google Sheets (Import 42 Clients)';
            }
        }

        // Load saved settings on page load
        window.addEventListener('load', () => {
            const savedSpreadsheetId = localStorage.getItem('spreadsheet_id');
            const savedSheetName = localStorage.getItem('sheet_name');
            
            if (savedSpreadsheetId) {
                const input = document.getElementById('spreadsheetId');
                if (input) input.value = savedSpreadsheetId;
            }
            
            if (savedSheetName) {
                const input = document.getElementById('sheetName');
                if (input) input.value = savedSheetName;
            }
        });
    </script>
</body>
</html>
